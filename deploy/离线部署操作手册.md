# Ldpj_backend 离线部署操作手册

**版本**: 2.1
**日期**: 2026-02-25
**作者**: Manus AI

---

## 1. 概述

本文档旨在指导技术人员在**完全离线**的Linux工控机上成功部署和运行Ldpj_backend边缘AI漏液检测系统。部署过程分为两个阶段：**准备阶段**（在可联网的开发机上完成）和**部署阶段**（在目标工控机上完成）。

### 1.1. 目标环境要求

| 组件 | 要求 |
|---|---|
| **操作系统** | Linux (Ubuntu 20.04+ / Debian 11+), x86_64架构 |
| **Python环境** | Python 3.11 或更高版本 (必须包含 `venv` 模块) |
| **硬件** | 工业PC，≥2GB RAM，≥8GB可用存储空间 |
| **PLC** | 西门子 S7-1200/1500，已配置DB9数据块 |

## 2. 准备阶段 (在线环境)

在开始离线部署前，需要在**一台可以访问互联网的开发计算机**上准备好所有必需的文件。这台开发机应与目标工控机具有相同的操作系统架构（x86_64）。

### 2.1. 下载项目代码

从GitHub克隆最新的项目代码。

```bash
git clone https://github.com/xiaofinesh/Ldpj_backend.git
cd Ldpj_backend
```

### 2.2. 制作离线Python依赖包

系统已包含一个脚本，可以自动下载所有Python依赖项的离线安装包（`.whl`文件）。

```bash
# 确保当前环境的 pip 是最新的
python3 -m pip install --upgrade pip

# 创建离线包存放目录
mkdir -p deploy/offline_packages

# 下载所有依赖
python3 -m pip download \
    -r requirements.txt \
    -d deploy/offline_packages \
    --python-version 3.11 \
    --platform manylinux2014_x86_64 \
    --only-binary=:all:
```

执行完毕后，`deploy/offline_packages/` 目录下将包含所有必需的 `.whl` 文件（约82MB）。

### 2.3. 准备离线系统依赖 (如果需要)

如果目标工控机是一个**最小化安装的Linux系统**，可能缺少`libsnap7-dev`库。建议从Debian/Ubuntu的官方源下载其`.deb`文件，并一并拷贝。

```bash
# 在一台联网的、相同系统版本的机器上执行
apt-get download libsnap7-dev
```

### 2.4. 打包部署文件

将整个`Ldpj_backend`项目文件夹（包含刚刚生成的`deploy/offline_packages`）打包成一个`.tar.gz`文件，以便通过U盘或其他介质拷贝到目标工控机。

```bash
cd ..
tar -czvf Ldpj_backend_deploy.tar.gz Ldpj_backend/
```

此时，`Ldpj_backend_deploy.tar.gz` 就是我们最终需要的部署包。

## 3. 部署阶段 (离线工控机)

将`Ldpj_backend_deploy.tar.gz`文件和可能需要的`.deb`文件（如`libsnap7-dev`）通过U盘拷贝到目标工控机的任意位置（例如 `/home/user/`）。

### 3.1. 解压部署包

```bash
tar -xzvf Ldpj_backend_deploy.tar.gz
cd Ldpj_backend
```

### 3.2. 安装系统依赖 (如果需要)

如果工控机缺少`libsnap7-dev`，请先安装。

```bash
sudo dpkg -i /path/to/libsnap7-dev_*.deb
```

### 3.3. 执行一键离线部署脚本

项目提供了一个自动化的离线部署脚本`deploy/offline_install.sh`。该脚本将完成所有必要的操作。

**重要提示**: 必须使用`sudo`权限运行此脚本。

```bash
sudo bash deploy/offline_install.sh
```

该脚本会自动执行以下所有步骤：

1.  **环境检查**：验证Python 3.11+环境是否满足要求。
2.  **文件复制**：将项目代码和配置文件复制到标准安装目录 `/opt/ldpj_backend`。
3.  **创建虚拟环境**：在 `/opt/ldpj_backend/.venv` 创建独立的Python虚拟环境。
4.  **离线安装依赖**：使用`deploy/offline_packages`中的`.whl`文件，完全离线地安装所有Python库。
5.  **创建启动脚本**：生成 `/opt/ldpj_backend/start.sh` 等便捷启动脚本。
6.  **配置systemd服务**：创建 `ldpj_backend.service`，实现开机自启和后台运行。

### 3.4. 配置系统

安装完成后，需要根据实际情况修改配置文件。

**核心配置：PLC连接**

```bash
sudo nano /opt/ldpj_backend/configs/plc.yaml
```

需要修改以下关键参数：

- `connection.ip`: PLC的实际IP地址。
- `cabin_array.cabin_count`: 测试舱室的数量，**必须与PLC项目中的数组大小一致**。

### 3.5. 部署模型文件

将训练好的模型文件夹（例如 `v1.0_20260225`）拷贝到工控机上，然后执行模型部署脚本。

```bash
sudo bash /opt/ldpj_backend/scripts/deploy_model.sh /path/to/your/model_folder
```

此脚本会将模型文件安全地部署到当前活动目录，并更新配置。

## 4. 运行与维护

### 4.1. 启动与停止服务

推荐使用`systemd`管理服务，因为它能提供后台运行、自动重启和集中的日志管理。

| 操作 | 命令 |
|---|---|
| **启动服务** | `sudo systemctl start ldpj_backend` |
| **停止服务** | `sudo systemctl stop ldpj_backend` |
| **设置开机自启** | `sudo systemctl enable ldpj_backend` |
| **取消开机自启** | `sudo systemctl disable ldpj_backend` |
| **查看服务状态** | `sudo systemctl status ldpj_backend` |

### 4.2. 查看日志

- **实时日志 (推荐)**:
  ```bash
  sudo journalctl -u ldpj_backend -f
  ```

- **文件日志**:
  ```bash
  tail -f /opt/ldpj_backend/logs/app.log
  ```

### 4.3. 手动运行 (用于调试)

如果不想通过`systemd`运行，也可以直接执行启动脚本进行前台调试。

```bash
# 切换到安装目录
cd /opt/ldpj_backend

# 生产模式 (连接真实PLC)
sudo ./start.sh

# Mock模式 (不连接PLC，用于测试)
sudo ./start_mock.sh
```

在前台运行时，可以通过键盘输入 `s/e/w/h/d/q` 等命令与程序交互。

## 5. 故障排查

| 问题 | 可能原因与解决方案 |
|---|---|
| **服务启动失败** | 1. 检查`journalctl -u ldpj_backend`的错误日志。<br>2. 确认Python版本和依赖是否正确安装。<br>3. 确认配置文件（特别是YAML格式）是否正确。 |
| **无法连接PLC** | 1. `ping <PLC_IP>` 检查网络连通性。<br>2. 确认`plc.yaml`中的IP、机架、插槽号是否正确。<br>3. 检查工控机防火墙是否允许与PLC的102端口通讯。 |
| **模型加载失败** | 1. 确认模型文件已通过`deploy_model.sh`正确部署。<br>2. 检查`models/artifacts/current/`目录下的文件是否完整。 |
| **磁盘空间不足** | 系统日志和数据库文件会占用空间。定期检查`/opt/ldpj_backend/logs`和`/opt/ldpj_backend/data`目录，归档或清理旧文件。 |

---
**
---
**文档结束**
结束**
**文档结束**
结束**
